# 从输入`URL`到页面展示

## 整体流程概述
1. 渲染进程将 HTML 内容转换为能够读懂的 DOM 树结构。
2. 渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式。
3. 创建布局树，并计算元素的布局信息。
4. 对布局树进行分层，并生成分层树。
5. 为每个图层生成绘制列表，并将其提交到合成线程。
6. 合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图。
7. 合成线程发送绘制图块命令 DrawQuad 给浏览器进程。
8. 浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上。

## 1. 用户输入
- 搜索内容
  使用浏览器默认的搜索引擎，合成带搜索关键字的`URL`
- 请求的`URL`
  判断内容若符合`URL`规则，地址栏将根据规则，为内容加上协议，合成完成的`URL`
  
**Note**: 用户输入关键字回车后，意味着当前页面即将要被替换成新页面，在替换之前，浏览器会给页面一次执行`beforeunload`事件的机会，用户可通过`beforeunload`事件取消导航，让浏览器不再执行后续工作。

## 2. `URL`请求过程

### 2.1 浏览器进程通过进程间通信（IPC）把`URL`请求发送至网络进程，网络进程收到`URL`请求后，发起`URL`请求流程
### 2.2 网络进程会查找本地缓存是否有缓存资源
    - 有，直接返回
    - 无，进入网络请求流程
      (1) 进行`DNS`解析，获取请求域名的服务器`IP`地址;
      (2) `HTTPS`协议，还需建立`TLS`连接
### 2.3 建立`TCP`连接
### 2.4 浏览器端构建请求行、请求头等信息，将与该域名相关的`Cookie`等数据附加到请求头，向服务器发送请求
### 2.5 服务器根据请求信息生成响应数据（包括响应行、响应头和响应体等信息）发送给网络进程
    - 重定向
    网络进程解析响应头，发现返回的状态码为`301`或`302`，会触发重定向。网络进程会从响应头的`Location`字段里读取重定向地址
    - 响应数据类型
    `Content-Type`：会告诉浏览器返回的响应体数据是什么类型

## 3. 渲染进程
`Chrome`为每个页面分配一个渲染进程，每打开一个新的页签就配套创建一个新的渲染进程

**Note**: 同一站点的多个页面会运行于同一渲染进程

同一站点: 
- 协议相同
- 根域名相同

同一站点样例如下：
```
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
```

`Chrome`的策略是：每个标签对应一个渲染进程。
**Note**: 从一个页面打开另一个新页面，新页面与当前页面处于同一站点，新页面将复用父页面的渲染进程

## 4. 提交文档
浏览器进程将网络进程接收的`HTML`数据提交给渲染进程

### 4.1 浏览器进程收到网络进程的响应头后，向渲染进程发起"提交文档"的消息;
### 4.2 渲染进程接收到消息后，与网络进程建立传输数据管道;
### 4.3 文档数据传输完毕，将发送"确认提交"的消息给浏览器进程;
### 4.4 浏览器进程收到"确认提交"消息后，更新浏览器界面状态（安全状态、地址栏`URL`、前进后退历史状态）;
### 4.5 更新`Web`页面

## 5. 渲染阶段
- 构建`DOM`树
- 样式计算
- 布局阶段
- 分层
- 绘制
- 分块
- 光栅化
- 合成

### 5.1 构建`DOM`树
浏览器无法直接理解和使用`HTML`，故需要将`HTML`转化为浏览器能够理解的`DOM`树
`html`文件 -> `html`解析器 -> `DOM`树

### 5.2 样式计算
计算出`DOM`节点中每个元素的具体样式

#### 5.2.1 CSS转化为浏览器可理解的结构
`CSS`文本 -> `CSS`解析器 -> `styleSheets`

`CSS`样式来源：
- 通过`link`引用的`css`文件
- `<style>`标记内的样式
- 内联样式

#### 5.2.2 样式表的属性值标准化
将所有属性值转化为标准化的计算值;

未标准化的属性值：
```css
body { font-size: 2em }
p { color: blue }
span { display: none }
div { font-weight: bold }
div p { color: green }
div { color: red }
```

标准化后的属性值：
```css
body { font-size: 32px }
p { color: rgb(0. 0. 255) }
span { display: none }
div { font-weight: 700 }
div p { color: rgb(0, 120, 0) }
div { color: rgb(255, 0, 0) }
```

#### 5.2.3 计算`DOM`树中每个节点的具体样式
- `CSS`继承规则
- `CSS`层叠规则

**Note**: `UserAgent`样式为浏览器提供的一组默认样式，不提供任何样式时，通常使用该样式

### 5.3 布局阶段
- 创建布局树
- 布局计算

### 5.4 分层
渲染引擎为特定的节点生成专用的图层，并生成一棵对应的图层树 (`Layers`工具可查看)

主要应用于：
- 复杂的`3D`变换
- 页面滚动
- `z-indexing`做z轴排序

#### 创建图层的触发条件
- 拥有层叠上下文属性的元素被提升为单独一层
- 需要裁剪 (`clip`) 的地方被创建为图层 (内容超出盒子时)
  - 文字超出时，文字部分单独创建一个层
  - 出现滚动条时，滚动条被提升为单独的层

### 5.5 图层绘制
将图层的绘制拆分为多个小的**绘制指令**，再将这些指令按照顺序组成一个待绘制列表

### 5.6 栅格化操作
1. 绘制列表准备完成后，主线程将绘制列表提交给**合成线程**;
2. 合成线程会将图层划分为瓦片 (tile);
3. 优先绘制视口附近的图块，实际生成位图操作由栅格化执行

### 5.7 合成 & 显示
所有图块光栅化后，合成线程生成一个绘制图块的命令 —— `DrawQuad`

## 影响性能的一些因素
- `重排`
- `重绘`
- `合成`

### 重排
通过`JavaScript`或`CSS`修改元素的集合位置属性，浏览器将触发重新布局

### 重绘
相对于重排，省去了布局和分层阶段，故执行效率将比重排操作高

### 直接合成
`CSS`的`transform`动画效果，可避开重排和重绘阶段





























