# 浏览器中的事件循环

## 消息队列方式
1. 创建一个消息队列;
2. 事件添加进消息队列尾部;
3. 渲染主进程循环从消息队列中读取任务，执行任务。

### 消息队列中的任务类型
- 输入事件（鼠标操作）
- 微任务
- 文件读写
- `WebSocket`
- `JavaScript`定时器

## 常用异步事件`WebAPI`
- `setTimeout`
- `XMLHttpRequest`

## `setTimeout`
设置回调函数时，渲染进程会创建一个回调任务，加入到延迟队列中

`clearTimeout`:
从延迟队列中，找到对应ID的任务，从队列中删除即可

使用`setTimeout`的注意事项：
1. 当前任务执行过久，影响定时任务的执行;
2. 定时器嵌套调用5次以上，系统会判断该函数方法被阻塞了，系统将设置最短时间间隔4ms;
3. 未激活的页面，定时器的最小间隔值为1000ms;
4. 延时执行时间为最大32位表示的整数;
5. `this`指向

## `XMLHttpRequest`

### 创建步骤

#### 1. 创建`XMLHttpRequest`对象
`let xhr = new XMLHttpRequest()`

#### 2. 为`xhr`添加回调函数
回调函数主要包含以下几种：
- `ontimeout`: 请求超时时，将调用该函数
- `onerror`: 请求出错时，调用该函数
- `onreadystatechange`: 监控后台请求中的状态 (监听`xhr.readyState`状态)
  - 0: 请求未初始化
  - 1: 请求初始化完成
  - 2: 获取到请求的头部信息
  - 3: 加载请求中
  - 4: 请求结束 (`this.status`的状态码为请求返回的状态码)

#### 3. `xhr.open`发起请求
- `open`函数中的参数为基础的请求信息，包括：
  - `URL`
  - 请求方法
  - 请求方式 （同步/异步）
- 其他配置项
  - `xhr.timeout`指定超时时间
  - `xhr.responseType`配置服务器返回的数据格式
  - `xhr.setRequestHeader`可以设置头部信息

#### 4. 发起请求
1. 调用`xhr.send`发起网络请求;
2. 渲染进程将请求发送给网络请求;
3. 网络进程收到数据后，通过`IPC`通信通知渲染进程;
4. 渲染进程收到消息后，将`xhr`的回调函数封装成任务添加到消息队列中

### `xhr`使用过程中的常见问题
1. 跨域问题
2. `HTTPS`混合内容问题

## 常见的宏任务
- 渲染事件
  - 解析DOM
  - 计算布局
  - 绘制
- 用户交互事件
  - 鼠标点击
  - 滚动页面
  - 放大缩小
- `JavaScript`脚本执行事件
- 网络请求完成、文件读写完成事件

## 微任务
执行时机：主函数执行结束之后，当前宏任务结束执行之前执行回调函数

### 微任务产生的时机
- `MutationObserver`监控某个`DOM`节点 (`DOM`节点变化时，触发变化记录的微任务)
- `Promise`
